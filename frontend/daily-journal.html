<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Journal - TradeNote</title>
  
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/dark-mode.css" />
  <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .form-input, .form-select {
      background-color: var(--background);
    }
  </style>
</head>
<body class="bg-background text-text-primary">
  <div id="app" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-sidebar-bg p-6 flex-shrink-0 flex flex-col">
      <div class="flex items-center gap-3 mb-8">
        <svg class="w-8 h-8 text-accent" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="font-display font-bold text-xl">TradeNote</span>
      </div>
      <nav class="space-y-2 flex-1">
        <a href="dashboard.html" class="sidebar-link">
          <i data-feather="home" class="sidebar-icon"></i>
          <span>Overview</span>
        </a>
        <a href="daily-journal.html" class="sidebar-link active">
          <i data-feather="book" class="sidebar-icon"></i>
          <span>Daily Journal</span>
        </a>
        <a href="trades.html" class="sidebar-link">
          <i data-feather="bar-chart-2" class="sidebar-icon"></i>
          <span>Trades</span>
        </a>
        <a href="notebook.html" class="sidebar-link">
          <i data-feather="edit-3" class="sidebar-icon"></i>
          <span>Notebook</span>
        </a>
        <a href="playbook.html" class="sidebar-link">
          <i data-feather="compass" class="sidebar-icon"></i>
          <span>Playbook</span>
        </a>
        <a href="events.html" class="sidebar-link">
          <i data-feather="calendar" class="sidebar-icon"></i>
          <span>Events</span>
        </a>
      </nav>
      <div>
        <a href="add-trades.html" class="btn btn-primary w-full">
            <i data-feather="plus" class="w-5 h-5"></i>
            <span>Add New Trade</span>
        </a>
      </div>
    </aside>

    <!-- Main area -->
    <main class="flex-1 p-8 overflow-auto">
      <header class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-4xl font-display font-bold">Daily Journal</h1>
          <p class="text-text-secondary" id="journal-date">Select a day to see your trades.</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="theme-toggler">
                <div class="icon active" id="light-mode-icon"><i data-feather="sun"></i></div>
                <div class="icon" id="dark-mode-icon"><i data-feather="moon"></i></div>
            </div>
            <button class="text-text-secondary hover:text-text-primary">
                <i data-feather="search" class="w-6 h-6"></i>
            </button>
            <button class="text-text-secondary hover:text-text-primary">
                <i data-feather="bell" class="w-6 h-6"></i>
            </button>
            <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-background font-bold text-lg" id="user-avatar-placeholder">R</div>
            <button id="logout-button" class="btn btn-secondary">Logout</button>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
            <div class="card p-6">
                <header class="flex justify-between items-center mb-4">
                    <h2 id="caltitle" class="text-lg font-semibold">Trade Calendar</h2>
                    <div class="month-nav flex items-center gap-2">
                      <button id="prevMonth" aria-label="Previous month" class="p-2 rounded-md hover:bg-muted"><i data-feather="chevron-left"></i></button>
                      <div id="monthLabel" aria-live="polite" class="font-semibold"></div>
                      <button id="nextMonth" aria-label="Next month" class="p-2 rounded-md hover:bg-muted"><i data-feather="chevron-right"></i></button>
                    </div>
                </header>
                <div class="grid grid-cols-7 gap-2 text-center text-xs text-text-secondary mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
            </div>
        </div>

        <aside class="card p-6" aria-labelledby="detailTitle">
            <div class="flex justify-between items-center mb-4">
                <h2 id="detailTitle" class="text-lg font-semibold">Daily Log</h2>
                <div id="selectedDate" class="text-sm text-text-secondary"></div>
            </div>
            <div id="daily-log-content">
                <div class="text-center py-12 text-text-secondary">
                    <i data-feather="calendar" class="w-16 h-16 mx-auto opacity-50"></i>
                    <p class="mt-4">Select a date to view trades and notes.</p>
                </div>
            </div>
        </aside>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'index.html';
            return;
        }

        // Logout functionality
        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        });

        // Fetch User Info
        const userResponse = await getUser();
        if (userResponse.ok) {
            const userData = await userResponse.json();
            if (userData.avatar) {
                document.getElementById('user-avatar-placeholder').innerHTML = `<img src="data:image/png;base64,${userData.avatar}" class="rounded-full w-full h-full object-cover" alt="User Avatar">`;
            } else {
                document.getElementById('user-avatar-placeholder').textContent = userData.username.charAt(0).toUpperCase();
            }
        }

        let currentMonthDate = new Date();
        let selectedDate = null;
        let tradesData = [];

        const renderJournalPage = async (date) => {
            currentMonthDate = date;
            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            
            const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const tradesResponse = await getTrades({ month: monthStr });
            tradesData = tradesResponse.ok ? (await tradesResponse.json()).trades : [];
            
            renderCalendar(tradesData);
            
            if (selectedDate) {
                renderDailyLog(selectedDate, tradesData);
            }
        };

        const renderCalendar = (trades) => {
            const calendarGrid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('monthLabel');
            calendarGrid.innerHTML = '';

            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            monthLabel.textContent = currentMonthDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                calendarGrid.innerHTML += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayTrades = trades.filter(t => t.entry_datetime.startsWith(dateStr));
                const pnl = dayTrades.reduce((sum, t) => sum + t.total_pnl, 0);

                const dayEl = document.createElement('a');
                dayEl.href = `#`;
                dayEl.className = 'calendar-day p-2 rounded-lg text-center h-24 flex flex-col justify-between cursor-pointer';
                
                let dayContent = `<div class="text-sm">${day}</div>`;
                if (dayTrades.length > 0) {
                    dayEl.classList.add(pnl >= 0 ? 'profit' : 'loss');
                    dayContent += `<div class="text-xs font-bold">${pnl >= 0 ? '+' : ''}${pnl.toFixed(0)}</div>`;
                }
                dayEl.innerHTML = dayContent;

                if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
                    dayEl.classList.add('selected');
                }

                dayEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectedDate = date;
                    renderCalendar(trades);
                    renderDailyLog(date, trades);
                });

                calendarGrid.appendChild(dayEl);
            }
        };

        const fetchAndDisplayScreenshot = async (trade, tradeElement) => {
            if (trade.screenshot_filename) {
                const screenshotUrl = `${API_BASE_URL}/trades/screenshots/${trade.screenshot_filename}`;
                const response = await fetch(screenshotUrl, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = "Trade screenshot";
                    img.className = "rounded-lg shadow-md border border-border-color mt-4";
                    tradeElement.appendChild(img);
                }
            }
        };

        const renderDailyLog = (date, allTrades) => {
            const dateStr = date.toISOString().split('T')[0];
            const dayTrades = allTrades.filter(t => t.entry_datetime.startsWith(dateStr));
            
            const journalDateEl = document.getElementById('journal-date');
            const dailyLogContent = document.getElementById('daily-log-content');
            const selectedDateEl = document.getElementById('selectedDate');
            
            journalDateEl.textContent = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            selectedDateEl.textContent = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            if (dayTrades.length === 0) {
                dailyLogContent.innerHTML = `<div class="text-center py-12 text-text-secondary"><i data-feather="calendar" class="w-16 h-16 mx-auto opacity-50"></i><p class="mt-4">No trades for this day.</p></div>`;
                feather.replace();
                return;
            }

            const totalPnl = dayTrades.reduce((sum, t) => sum + t.total_pnl, 0);
            const wins = dayTrades.filter(t => t.result === 'Win').length;
            const losses = dayTrades.length - wins;

            let tradesHtml = dayTrades.map(trade => `
                <div class="border-t border-border-color pt-4 mt-4" data-trade-id="${trade.id}">
                    <div class="flex justify-between items-center">
                        <div class="font-semibold text-lg">${trade.ticker}</div>
                        <div class="font-bold text-lg ${trade.total_pnl >= 0 ? 'text-success' : 'text-danger'}">${trade.total_pnl.toFixed(2)}</div>
                    </div>
                    <p class="text-sm text-text-secondary mt-2">${trade.trade_note || 'No note.'}</p>
                </div>
            `).join('');

            dailyLogContent.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="text-right">
                        <div class="text-sm text-text-secondary">Total PNL</div>
                        <div class="text-2xl font-bold ${totalPnl >= 0 ? 'text-success' : 'text-danger'}">${totalPnl.toFixed(2)}</div>
                    </div>
                </div>
                <div class="flex gap-4 text-sm mb-4 pb-4 border-b border-border-color">
                    <div><strong>Trades:</strong> ${dayTrades.length}</div>
                    <div><strong>Wins:</strong> <span class="text-success font-semibold">${wins}</span></div>
                    <div><strong>Losses:</strong> <span class="text-danger font-semibold">${losses}</span></div>
                </div>
                <div class="mt-4">
                   <h4 class="font-semibold mb-4">Trade Reviews</h4>
                   ${tradesHtml}
                </div>
            `;

            dayTrades.forEach(trade => {
                const tradeElement = dailyLogContent.querySelector(`[data-trade-id="${trade.id}"]`);
                if (tradeElement) {
                    fetchAndDisplayScreenshot(trade, tradeElement);
                }
            });

            feather.replace();
        };

        document.getElementById('prevMonth').addEventListener('click', () => {
            const newDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() - 1, 1);
            renderJournalPage(newDate);
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            const newDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + 1, 1);
            renderJournalPage(newDate);
        });

        await renderJournalPage(currentMonthDate);
        
        // Feather icons
        feather.replace();
        // AOS
        AOS.init({
            duration: 800,
            once: true,
        });
        // Theme
        initializeTheme();
    });
  </script>
</body>
</html>